<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Card Generator - Indian Universities</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { 
            background: #f0f0f0; 
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .btn {
            padding: 12px 24px;
            margin: 0 10px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-generate {
            background: #4CAF50;
            color: white;
        }
        
        .btn-generate:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .btn-download {
            background: #2196F3;
            color: white;
            opacity: 0.7;
            transition: all 0.3s ease;
        }
        
        .btn-download:hover:not(:disabled) {
            background: #0b7dda;
            transform: translateY(-2px);
        }
        
        .btn-download:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .card {
            width: 600px;
            min-height: 370px;
            background: #fff;
            border: 2px solid #222;
            border-radius: 10px;
            margin: 0 auto 40px auto;
            font-family: Arial, sans-serif;
            position: relative;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            overflow: visible;
            padding-bottom: 40px;
        }
        .header {
            background: #6a9ed8;
            color: #fff;
            padding: 16px 24px 10px 24px;
            position: relative;
            min-height: 80px;
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .logo {
            position: static;
            width: 80px;
            height: 80px;
            object-fit: contain;
            background: #fff;
            border-radius: 6px;
            padding: 4px;
            flex-shrink: 0;
        }
        .header-text {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .title {
            font-size: 26px;
            font-weight: bold;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }
        .subtitle {
            color: #c00;
            font-size: 22px;
            font-weight: bold;
            margin-top: 2px;
        }
        .info-section {
            display: flex;
            flex-wrap: wrap;
            padding: 16px 24px 0 24px;
        }
        .avatar {
            width: 110px;
            height: 135px;
            object-fit: cover;
            border: 2px solid #888;
            border-radius: 6px;
            margin-right: 28px;
            background: #eee;
            flex-shrink: 0;
        }
        .details {
            flex: 1;
            font-size: 17px;
            min-width: 220px;
        }
        .details b {
            font-size: 18px;
        }
        .label {
            color: #1a7ec7;
            font-weight: bold;
        }
        .row {
            margin-bottom: 7px;
            word-break: break-word;
        }
        .row .label {
            width: 110px;
            display: inline-block;
        }
        .barcode {
            width: 90%;
            height: 38px;
            margin: 14px auto 0 auto;
            display: block;
        }
        .footer {
            font-size: 14px;
            color: #444;
            text-align: left;
            padding: 0 24px 0 24px;
            margin-top: 8px;
        }
        .id-number {
            position: absolute;
            left: 24px;
            bottom: 18px;
            font-size: 15px;
            color: #222;
            background: #fff;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .region {
            position: absolute;
            right: 24px;
            bottom: 18px;
            font-size: 15px;
            color: #222;
            background: #fff;
            padding: 2px 8px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <h1>Student Card Generator - Indian Universities</h1>
            <button class="btn btn-generate" onclick="generateStudentCard()">Generate New Student Card</button>
            <button class="btn btn-download" onclick="downloadCard()" disabled>Download Card</button>
        </div>
        
        <div id="student-card">
            <div class="card">
                <div class="header">
                    <img class="logo" id="university-logo" src="https://i.pinimg.com/736x/64/07/67/6407676eb7f221b13cf517923d0c3652.jpg" alt="University Logo">
                    <div class="header-text">
                        <div class="title" id="university-name">Manipal Academy of Higher Education</div>
                        <div class="subtitle">STUDENT CARD</div>
                    </div>
                </div>
                <div class="info-section">
                    <img class="avatar" id="student-photo" src="https://channel.mediacdn.vn/prupload/879/2018/05/img20180503174618883.jpg" alt="Student Photo">
                    <div class="details">
                        <div class="row"><span class="label">Name:</span> <b id="student-name">Jayson Jame</b></div>
                        <div class="row"><span class="label">Date of Birth:</span> <span id="student-dob">2003-10-10</span></div>
                        <div class="row"><span class="label">Course:</span> <span id="student-course">2025 - 2028</span></div>
                        <div class="row"><span class="label">Class:</span> <span id="student-class">MIT-CS-BTech-2024</span></div>
                        <div class="row"><span class="label">Department:</span> <span id="student-department">Information Technology</span></div>
                    </div>
                </div>
                <div class="footer">
                    Valid until: <b id="valid-until">30/12/2027</b>
                </div>
                <img class="barcode" id="barcode" src="/api/barcode?data=Manipal Academy of Higher Education&code=Code128" alt="Barcode">
                <div class="id-number" id="student-id">Student ID: MAHE2025.0370467829</div>
                <div class="region">India</div>
            </div>
        </div>
    </div>

    <script>
        // Danh sách các trường đại học
        const universities = [
            {
                name: "Indian Institute of Technology Bombay",
                shortName: "IITB",
                logo: "https://upload.wikimedia.org/wikipedia/en/1/1d/Indian_Institute_of_Technology_Bombay_Logo.svg"
            },
            {
                name: "Indian Institute of Technology Delhi",
                shortName: "IITD",
                logo: "https://upload.wikimedia.org/wikipedia/en/f/fd/Indian_Institute_of_Technology_Delhi_Logo.svg"
            },
            {
                name: "Indian Institute of Science Bangalore",
                shortName: "IISc",
                logo: "https://engageindia.ca/wp-content/uploads/2017/01/IISc-500x500.png"
            },
            {
                name: "Indian Institute of Technology Madras",
                shortName: "IITM",
                logo: "https://upload.wikimedia.org/wikipedia/en/6/69/IIT_Madras_Logo.svg"
            },
            {
                name: "Indian Institute of Technology Kanpur",
                shortName: "IITK",
                logo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTzlbzSORQuaiBM1uuqdVUtJh3WB0-YjbTMiA&s"
            },
            {
                name: "Indian Institute of Technology Kharagpur",
                shortName: "IITKgp",
                logo: "https://upload.wikimedia.org/wikipedia/en/1/1c/IIT_Kharagpur_Logo.svg"
            },
            {
                name: "University of Delhi",
                shortName: "DU",
                logo: "https://upload.wikimedia.org/wikipedia/commons/e/e9/University_of_delhi_logo.png"
            },
            {
                name: "Jawaharlal Nehru University",
                shortName: "JNU",
                logo: "https://pbs.twimg.com/media/GAgQfbPbsAADBVf.jpg"
            },
            {
                name: "Indian Institute of Management Ahmedabad",
                shortName: "IIMA",
                logo: "https://upload.wikimedia.org/wikipedia/en/thumb/c/cd/IIM%2C_Ahmedabad_Logo.svg/1200px-IIM%2C_Ahmedabad_Logo.svg.png"
            },
            {
                name: "Banaras Hindu University",
                shortName: "BHU",
                logo: "https://upload.wikimedia.org/wikipedia/en/c/ca/Banaras_Hindu_University_Emblem_Seal_Transparent.png"
            }
        ];

        // Danh sách tên Ấn Độ
        const indianNames = [
            "Aarav Sharma", "Vivaan Patel", "Aditya Gupta", "Vihaan Singh", "Arjun Kumar",
            "Sai Reddy", "Reyansh Agarwal", "Ayaan Khan", "Krishna Joshi", "Ishaan Verma",
            "Ananya Sharma", "Diya Patel", "Aadhya Gupta", "Kavya Singh", "Anvi Kumar",
            "Saanvi Reddy", "Larisa Agarwal", "Myra Khan", "Aanya Joshi", "Pihu Verma",
            "Aryan Mehta", "Kabir Nair", "Shivansh Roy", "Atharv Das", "Rudra Bose",
            "Priya Iyer", "Riya Ghosh", "Sara Banerjee", "Tara Kulkarni", "Nisha Desai"
        ];

        // Danh sách chuyên ngành
        const departments = [
            "Computer Science", "Information Technology", "Electronics Engineering",
            "Mechanical Engineering", "Civil Engineering", "Chemical Engineering",
            "Biotechnology", "Physics", "Mathematics", "Chemistry", "Business Administration",
            "Economics", "Psychology", "English Literature", "History", "Political Science"
        ];
        // Hàm lấy ảnh từ thispersonnotexist.org qua proxy server
        async function getRandomStudentPhoto() {
            try {
                // Sử dụng proxy server local để bypass CORS
                const response = await fetch('/api/load-faces', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        "type": "R",
                        "age": "21-35",
                        "race": "asian", 
                        "emotion": "none"
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.fc && data.fc.length > 0) {
                        // Chọn ngẫu nhiên một ảnh từ danh sách
                        const randomIndex = Math.floor(Math.random() * data.fc.length);
                        const base64Image = data.fc[randomIndex];
                        
                        // Tạo URL qua proxy server để tránh CORS khi download
                        const imageUrl = `/api/image/${base64Image}`;
                        
                        return imageUrl;
                        
                    } else {
                        throw new Error('Không có ảnh trong response');
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(`HTTP ${response.status}: ${errorData.error || response.statusText}`);
                }
                
            } catch (error) {
                throw error; // Re-throw để báo lỗi cho user
            }
        }

        function getRandomElement(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function generateRandomDate() {
            const today = new Date();
            const minAge = 20;
            const maxAge = 25;
            
            const randomAge = minAge + Math.floor(Math.random() * (maxAge - minAge + 1));
            const birthYear = today.getFullYear() - randomAge;
            const birthMonth = Math.floor(Math.random() * 12) + 1;
            const birthDay = Math.floor(Math.random() * 28) + 1;
            
            return `${birthYear}-${birthMonth.toString().padStart(2, '0')}-${birthDay.toString().padStart(2, '0')}`;
        }

        function generateStudentID(universityShort) {
            const year = new Date().getFullYear();
            const randomNumber = Math.floor(Math.random() * 9999999999).toString().padStart(10, '0');
            return `${universityShort}${year}.${randomNumber}`;
        }

        function generateCourse() {
            const currentYear = new Date().getFullYear();
            const startYear = currentYear;
            const endYear = startYear + 4;
            return `${startYear} - ${endYear}`;
        }

        function generateClass() {
            const departments = ["CS", "IT", "EE", "ME", "CE", "CHE", "BT"];
            const degrees = ["BTech", "MTech", "PhD", "BSc", "MSc"];
            const year = new Date().getFullYear();
            
            return `${getRandomElement(departments)}-${getRandomElement(degrees)}-${year}`;
        }

        function generateValidUntil() {
            const today = new Date();
            const validDate = new Date(today.getFullYear() + 3, today.getMonth(), today.getDate());
            return validDate.toLocaleDateString('en-GB');
        }

        async function generateStudentCard() {
            // Hiển thị loading state
            const generateBtn = document.querySelector('.btn-generate');
            const originalText = generateBtn.textContent;
            generateBtn.textContent = 'Generating...';
            generateBtn.disabled = true;

            try {
                const university = getRandomElement(universities);
                const studentName = getRandomElement(indianNames);
                const department = getRandomElement(departments);
                const dob = generateRandomDate();
                const course = generateCourse();
                const studentClass = generateClass();
                const studentID = generateStudentID(university.shortName);
                const validUntil = generateValidUntil();

                // Lấy ảnh từ API thispersonnotexist.org (chỉ sử dụng API này)
                const studentPhoto = await getRandomStudentPhoto();

                // Cập nhật thông tin trên card
                document.getElementById('university-name').textContent = university.name;
                document.getElementById('student-name').textContent = studentName;
                document.getElementById('student-dob').textContent = dob;
                document.getElementById('student-course').textContent = course;
                document.getElementById('student-class').textContent = studentClass;
                document.getElementById('student-department').textContent = department;
                document.getElementById('student-id').textContent = `Student ID: ${studentID}`;
                document.getElementById('valid-until').textContent = validUntil;
                
                // Load ảnh đơn giản
                document.getElementById('university-logo').src = university.logo;
                document.getElementById('student-photo').src = studentPhoto;
                
                // Cập nhật barcode với tên trường qua proxy
                const barcodeUrl = `/api/barcode?data=${encodeURIComponent(university.name)}&code=Code128`;
                document.getElementById('barcode').src = barcodeUrl;
                
                // Chờ một chút để ảnh load
                await new Promise(resolve => setTimeout(resolve, 1000));

            } catch (error) {
                alert(`Lỗi: Không thể lấy ảnh từ thispersonnotexist.org\n${error.message}\n\nVui lòng kiểm tra kết nối internet và thử lại.`);
            } finally {
                // Restore button state
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
                
                // Enable download button after generation
                const downloadBtn = document.querySelector('.btn-download');
                downloadBtn.disabled = false;
                downloadBtn.style.opacity = '1';
            }
        }

        async function downloadCard() {
            const downloadBtn = document.querySelector('.btn-download');
            const originalText = downloadBtn.textContent;
            
            try {
                downloadBtn.textContent = 'Creating image...';
                downloadBtn.disabled = true;
                
                // Tạo canvas thủ công thay vì dùng html2canvas
                await drawCardManually();
                
            } catch (error) {
                console.error('Download error:', error);
                alert('Không thể tải ảnh. Lỗi: ' + error.message);
            } finally {
                downloadBtn.textContent = originalText;
                downloadBtn.disabled = false;
            }
        }
        
        async function drawCardManually() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Kích thước canvas - match chính xác với web design
            canvas.width = 1200; // 600px * 2
            canvas.height = 800;  // ~400px * 2
            
            // Background
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Card setup - centered
            const cardX = 100, cardY = 100;
            const cardWidth = 1000, cardHeight = 600;
            
            // Card shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
            ctx.fillRect(cardX + 8, cardY + 8, cardWidth, cardHeight);
            
            // Card background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(cardX, cardY, cardWidth, cardHeight);
            
            // Card border với rounded corners
            ctx.strokeStyle = '#222222';
            ctx.lineWidth = 4;
            ctx.strokeRect(cardX, cardY, cardWidth, cardHeight);
            
            // Header background
            const headerHeight = 160;
            ctx.fillStyle = '#6a9ed8';
            ctx.fillRect(cardX, cardY, cardWidth, headerHeight);
            
            // Load và vẽ logo university
            try {
                const logoImg = new Image();
                logoImg.crossOrigin = 'anonymous';
                await new Promise((resolve) => {
                    logoImg.onload = resolve;
                    logoImg.onerror = resolve;
                    logoImg.src = document.getElementById('university-logo').src;
                    setTimeout(resolve, 3000);
                });
                
                if (logoImg.complete && logoImg.naturalWidth > 0) {
                    // Logo background trắng - match với CSS (.logo)
                    ctx.fillStyle = '#ffffff';
                    const logoSize = 128; // 80px * 1.6 scale
                    const logoX = cardX + 32;
                    const logoY = cardY + 16; 
                    
                    ctx.fillRect(logoX, logoY, logoSize, logoSize);
                    
                    // Draw logo với padding 8px
                    ctx.drawImage(logoImg, logoX + 8, logoY + 8, logoSize - 16, logoSize - 16);
                } else {
                    // Logo placeholder
                    const logoSize = 128;
                    const logoX = cardX + 32;
                    const logoY = cardY + 16;
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(logoX, logoY, logoSize, logoSize);
                    ctx.strokeStyle = '#cccccc';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(logoX, logoY, logoSize, logoSize);
                    ctx.fillStyle = '#666666';
                    ctx.font = 'bold 18px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('LOGO', logoX + logoSize/2, logoY + logoSize/2);
                }
            } catch (e) {
                console.warn('Logo loading failed:', e);
            }
            
            // University name - bắt đầu từ bên phải logo
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 42px Arial'; // Match với CSS .title
            ctx.textAlign = 'left';
            const universityName = document.getElementById('university-name').textContent;
            
            const textStartX = cardX + 192; // 32 + 128 + 32 margin
            const maxTextWidth = 740; // Remaining width
            const lines = wrapText(ctx, universityName, maxTextWidth);
            
            lines.forEach((line, index) => {
                ctx.fillText(line, textStartX, cardY + 50 + (index * 45));
            });
            
            // "STUDENT CARD" text - positioned below university name
            ctx.fillStyle = '#cc0000';
            ctx.font = 'bold 36px Arial'; // Match với CSS .subtitle
            const studentCardY = cardY + 50 + (lines.length * 45) + 15;
            ctx.fillText('STUDENT CARD', textStartX, studentCardY);
            
            // Info section - bắt đầu dưới header
            const infoY = cardY + headerHeight + 32;
            
            // Load và vẽ student photo
            try {
                const photoImg = new Image();
                photoImg.crossOrigin = 'anonymous';
                await new Promise((resolve) => {
                    photoImg.onload = resolve;
                    photoImg.onerror = resolve;
                    photoImg.src = document.getElementById('student-photo').src;
                    setTimeout(resolve, 3000);
                });
                
                // Photo dimensions match CSS .avatar
                const photoWidth = 176; // 110px * 1.6
                const photoHeight = 216; // 135px * 1.6
                const photoX = cardX + 48;
                const photoY = infoY;
                
                if (photoImg.complete && photoImg.naturalWidth > 0) {
                    // Photo border
                    ctx.strokeStyle = '#888888';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(photoX, photoY, photoWidth, photoHeight);
                    
                    // Clip và draw photo
                    ctx.save();
                    ctx.beginPath();
                    ctx.rect(photoX, photoY, photoWidth, photoHeight);
                    ctx.clip();
                    ctx.drawImage(photoImg, photoX, photoY, photoWidth, photoHeight);
                    ctx.restore();
                } else {
                    // Photo placeholder
                    ctx.fillStyle = '#eeeeee';
                    ctx.fillRect(photoX, photoY, photoWidth, photoHeight);
                    ctx.strokeStyle = '#888888';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(photoX, photoY, photoWidth, photoHeight);
                    ctx.fillStyle = '#666666';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('PHOTO', photoX + photoWidth/2, photoY + photoHeight/2);
                }
            } catch (e) {
                console.warn('Photo loading failed:', e);
            }
            
            // Student details - positioning bên phải photo
            ctx.textAlign = 'left';
            const detailsX = cardX + 48 + 176 + 44; // photoX + photoWidth + margin (match CSS)
            
            const details = [
                { label: 'Name:', value: document.getElementById('student-name').textContent, bold: true },
                { label: 'Date of Birth:', value: document.getElementById('student-dob').textContent },
                { label: 'Course:', value: document.getElementById('student-course').textContent },
                { label: 'Class:', value: document.getElementById('student-class').textContent },
                { label: 'Department:', value: document.getElementById('student-department').textContent }
            ];
            
            details.forEach((detail, index) => {
                const y = infoY + 20 + (index * 36); // Match CSS line spacing
                
                // Label (blue, bold) - match CSS .label
                ctx.fillStyle = '#1a7ec7';
                ctx.font = 'bold 27px Arial'; // Match CSS font-size
                
                // Fixed width cho label như CSS (.row .label width: 110px)
                const labelWidth = 176; // 110px * 1.6 scale
                ctx.fillText(detail.label, detailsX, y);
                
                // Value - positioned after fixed label width
                ctx.fillStyle = '#000000';
                ctx.font = detail.bold ? 'bold 29px Arial' : '27px Arial'; // Match CSS
                ctx.fillText(detail.value, detailsX + labelWidth + 16, y);
            });
            
            // Valid until - match CSS .footer positioning
            ctx.fillStyle = '#444444';
            ctx.font = '22px Arial'; // Match CSS .footer font-size
            const validText = `Valid until: ${document.getElementById('valid-until').textContent}`;
            const validY = infoY + 240; // Tăng khoảng cách để không đè lên photo
            ctx.fillText(validText, cardX + 48, validY);
            
            // Load và vẽ barcode thật từ API
            try {
                const barcodeImg = new Image();
                barcodeImg.crossOrigin = 'anonymous';
                await new Promise((resolve) => {
                    barcodeImg.onload = resolve;
                    barcodeImg.onerror = resolve;
                    barcodeImg.src = document.getElementById('barcode').src;
                    setTimeout(resolve, 3000); // Timeout after 3 seconds
                });
                
                const barcodeY = validY + 24;
                const barcodeStartX = cardX + 80; // Centered like CSS
                const barcodeWidth = 840; // 90% of card width
                const barcodeHeight = 60; // Match CSS height scaled
                
                if (barcodeImg.complete && barcodeImg.naturalWidth > 0) {
                    // Draw real barcode image
                    ctx.drawImage(barcodeImg, barcodeStartX, barcodeY, barcodeWidth, barcodeHeight);
                } else {
                    // Fallback: draw simple barcode pattern if image fails
                    ctx.fillStyle = '#000000';
                    const universityNameForBarcode = document.getElementById('university-name').textContent;
                    for (let i = 0; i < barcodeWidth; i += 3) {
                        const charIndex = Math.floor(i / 20) % universityNameForBarcode.length;
                        const charCode = universityNameForBarcode.charCodeAt(charIndex);
                        const shouldDraw = (charCode + i) % 7 !== 0;
                        if (shouldDraw) {
                            const lineWidth = ((charCode + i) % 3) + 1;
                            const lineHeight = barcodeHeight * (0.8 + ((charCode + i) % 3) * 0.1);
                            ctx.fillRect(barcodeStartX + i, barcodeY, lineWidth, lineHeight);
                        }
                    }
                }
            } catch (e) {
                console.warn('Barcode loading failed:', e);
                // Fallback barcode drawing code ở đây
                ctx.fillStyle = '#000000';
                const barcodeY = validY + 24;
                const barcodeStartX = cardX + 80;
                const barcodeWidth = 840;
                const barcodeHeight = 60;
                const universityNameForBarcode = document.getElementById('university-name').textContent;
                for (let i = 0; i < barcodeWidth; i += 3) {
                    const charIndex = Math.floor(i / 20) % universityNameForBarcode.length;
                    const charCode = universityNameForBarcode.charCodeAt(charIndex);
                    const shouldDraw = (charCode + i) % 7 !== 0;
                    if (shouldDraw) {
                        const lineWidth = ((charCode + i) % 3) + 1;
                        const lineHeight = barcodeHeight * (0.8 + ((charCode + i) % 3) * 0.1);
                        ctx.fillRect(barcodeStartX + i, barcodeY, lineWidth, lineHeight);
                    }
                }
            }
            
            // Footer elements - match CSS .id-number và .region positioning
            const footerY = cardY + cardHeight - 36; // Match CSS bottom positioning
            
            // Student ID (bottom left)
            ctx.fillStyle = '#222222';
            ctx.font = '24px Arial'; // Match CSS .id-number font-size
            ctx.textAlign = 'left';
            const studentId = document.getElementById('student-id').textContent;
            ctx.fillText(studentId, cardX + 48, footerY);
            
            // India (bottom right)
            ctx.textAlign = 'right';
            ctx.fillText('India', cardX + cardWidth - 48, footerY);
            
            // Download the canvas
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                link.download = `student-card-${timestamp}.png`;
                link.href = url;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                console.log('Download completed successfully!');
            }, 'image/png', 1.0);
        }
        
        function wrapText(ctx, text, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = words[0];
            
            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = ctx.measureText(currentLine + ' ' + word).width;
                if (width < maxWidth) {
                    currentLine += ' ' + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        // Generate initial card khi trang được load
        window.onload = async function() {
            await generateStudentCard();
        };
    </script>
</body>
</html>