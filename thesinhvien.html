<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="monetag" content="553507e471efcbe787b8c5c5c01a2aec">
    <meta charset="UTF-8">
    <title>Student Card Generator - Indian Universities</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .header-section {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .main-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }
        
        .controls h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .btn-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 180px;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-generate {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .btn-generate:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.6);
        }
        
        .btn-download {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
            transition: all 0.3s ease;
        }
        
        .btn-download:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.6);
        }
        
        .btn-download:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 5px rgba(33, 150, 243, 0.2);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff30;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .card-wrapper {
            perspective: 1000px;
            margin-bottom: 30px;
        }
        .card {
            width: 650px;
            min-height: 400px;
            background: #fff;
            border: none;
            border-radius: 20px;
            margin: 0 auto 40px auto;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            position: relative;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1), 0 5px 15px rgba(0,0,0,0.07);
            overflow: hidden;
            padding-bottom: 40px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: cardAppear 0.6s ease-out;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15), 0 8px 20px rgba(0,0,0,0.1);
        }
        
        @keyframes cardAppear {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .header {
            background: linear-gradient(135deg, #6a9ed8, #4a7db8);
            color: #fff;
            padding: 20px 30px 15px 30px;
            position: relative;
            min-height: 90px;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .header::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcf7f, #4ecdc4, #45b7d1);
        }
        
        .logo {
            position: static;
            width: 85px;
            height: 85px;
            object-fit: contain;
            background: #fff;
            border-radius: 12px;
            padding: 6px;
            flex-shrink: 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .header-text {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .title {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            color: #ffd700;
            font-size: 22px;
            font-weight: 600;
            margin-top: 2px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .info-section {
            display: flex;
            flex-wrap: wrap;
            padding: 20px 30px 0 30px;
            gap: 25px;
        }
        
        .avatar {
            width: 120px;
            height: 145px;
            object-fit: cover;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            background: #f5f5f5;
            flex-shrink: 0;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .avatar:hover {
            transform: scale(1.05);
        }
        
        .details {
            flex: 1;
            font-size: 17px;
            min-width: 250px;
        }
        
        .details b {
            font-size: 18px;
            font-weight: 600;
        }
        
        .label {
            color: #2c5aa0;
            font-weight: 600;
            display: inline-block;
            min-width: 120px;
        }
        
        .row {
            margin-bottom: 10px;
            padding: 5px 0;
            word-break: break-word;
            transition: background-color 0.2s ease;
            border-radius: 6px;
            padding: 8px 10px;
            margin: 5px -10px;
        }
        
        .row:hover {
            background-color: #f8f9fa;
        }
        
        .barcode {
            width: 85%;
            height: 40px;
            margin: 18px auto 0 auto;
            display: block;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .footer {
            font-size: 15px;
            color: #555;
            text-align: left;
            padding: 0 30px 0 30px;
            margin-top: 15px;
            font-weight: 500;
        }
        
        .id-number {
            position: absolute;
            left: 30px;
            bottom: 15px;
            font-size: 14px;
            color: #333;
            background: rgba(255,255,255,0.9);
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .region {
            position: absolute;
            right: 30px;
            bottom: 15px;
            font-size: 14px;
            color: #333;
            background: rgba(255,255,255,0.9);
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .main-title {
                font-size: 2rem;
            }
            
            .card {
                width: 100%;
                max-width: 500px;
            }
            
            .btn-container {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 250px;
            }
            
            .info-section {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .details {
                text-align: left;
            }
        }
        
        /* Loading Animation */
        .generating {
            position: relative;
            overflow: hidden;
        }
        
        .generating::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 300px;
            font-weight: 500;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-left: 4px solid #4CAF50;
        }
        
        .notification.error {
            border-left: 4px solid #f44336;
        }
        
        .notification.info {
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-section">
            <h1 class="main-title">🎓 Student Card Generator</h1>
            <p class="subtitle">Create professional student ID cards for Indian Universities</p>
        </div>
        
        <div class="controls">
            <h2>🚀 Card Generator</h2>
            <div class="btn-container">
                <button class="btn btn-generate" onclick="generateStudentCard()">
                    <span class="btn-text">🎲 Generate New Card</span>
                </button>
                <button class="btn btn-download" onclick="downloadCard()" disabled>
                    💾 Download Card
                </button>
            </div>
        </div>
        
        <div class="card-wrapper">
            <div id="student-card">
                <div class="card">
                    <div class="header">
                        <img class="logo" id="university-logo" src="https://i.pinimg.com/736x/64/07/67/6407676eb7f221b13cf517923d0c3652.jpg" alt="University Logo">
                        <div class="header-text">
                            <div class="title" id="university-name">Manipal Academy of Higher Education</div>
                            <div class="subtitle">STUDENT CARD</div>
                        </div>
                </div>
                <div class="info-section">
                    <img class="avatar" id="student-photo" src="https://channel.mediacdn.vn/prupload/879/2018/05/img20180503174618883.jpg" alt="Student Photo">
                    <div class="details">
                        <div class="row"><span class="label">👤 Name:</span> <b id="student-name">Jayson Jame</b></div>
                        <div class="row"><span class="label">📅 Date of Birth:</span> <span id="student-dob">2003-10-10</span></div>
                        <div class="row"><span class="label">📚 Course:</span> <span id="student-course">2025 - 2028</span></div>
                        <div class="row"><span class="label">🎒 Class:</span> <span id="student-class">MIT-CS-BTech-2024</span></div>
                        <div class="row"><span class="label">🏛️ Department:</span> <span id="student-department">Information Technology</span></div>
                    </div>
                </div>
                <div class="footer">
                    ⏰ Valid until: <b id="valid-until">30/12/2027</b>
                </div>
                <img class="barcode" id="barcode" src="/api/barcode?data=Manipal Academy of Higher Education&code=Code128" alt="Barcode">
                <div class="id-number" id="student-id">🆔 Student ID: MAHE2025.0370467829</div>
                <div class="region">🇮🇳 India</div>
            </div>
        </div>
    </div>

    <!-- Footer Section -->
    <footer style="text-align: center; padding: 30px 20px; color: rgba(255,255,255,0.8); margin-top: 50px;">
        <div style="max-width: 600px; margin: 0 auto;">
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 1.2rem; margin-bottom: 10px; color: #fff;">🎓 Student Card Generator</h3>
                <p style="font-size: 0.95rem; line-height: 1.6;">
                    Generate professional student ID cards for Indian Universities with realistic data and photos. 
                    Perfect for testing, demos, or educational purposes.
                </p>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-bottom: 20px; font-size: 0.9rem;">
                <div>✨ <strong>10+</strong> Universities</div>
                <div>👥 <strong>30+</strong> Names</div>
                <div>🏫 <strong>16</strong> Departments</div>
                <div>🖼️ <strong>AI</strong> Generated Photos</div>
            </div>
            
            <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px; font-size: 0.85rem;">
                <p>Made with ❤️ for educational purposes • Generate responsibly</p>
                <p style="margin-top: 10px; opacity: 0.7;">© 2025 Student Card Generator • All cards are for demonstration only</p>
            </div>
        </div>
    </footer>

    <script>
        // Danh sách các trường đại học
        const universities = [
            {
                name: "Indian Institute of Technology Bombay",
                shortName: "IITB",
                logo: "https://upload.wikimedia.org/wikipedia/en/1/1d/Indian_Institute_of_Technology_Bombay_Logo.svg"
            },
            {
                name: "Indian Institute of Technology Delhi",
                shortName: "IITD",
                logo: "https://upload.wikimedia.org/wikipedia/en/f/fd/Indian_Institute_of_Technology_Delhi_Logo.svg"
            },
            {
                name: "Indian Institute of Science Bangalore",
                shortName: "IISc",
                logo: "https://engageindia.ca/wp-content/uploads/2017/01/IISc-500x500.png"
            },
            {
                name: "Indian Institute of Technology Madras",
                shortName: "IITM",
                logo: "https://upload.wikimedia.org/wikipedia/en/6/69/IIT_Madras_Logo.svg"
            },
            {
                name: "Indian Institute of Technology Kanpur",
                shortName: "IITK",
                logo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTzlbzSORQuaiBM1uuqdVUtJh3WB0-YjbTMiA&s"
            },
            {
                name: "Indian Institute of Technology Kharagpur",
                shortName: "IITKgp",
                logo: "https://upload.wikimedia.org/wikipedia/en/1/1c/IIT_Kharagpur_Logo.svg"
            },
            {
                name: "University of Delhi",
                shortName: "DU",
                logo: "https://upload.wikimedia.org/wikipedia/commons/e/e9/University_of_delhi_logo.png"
            },
            {
                name: "Jawaharlal Nehru University",
                shortName: "JNU",
                logo: "https://pbs.twimg.com/media/GAgQfbPbsAADBVf.jpg"
            },
            {
                name: "Indian Institute of Management Ahmedabad",
                shortName: "IIMA",
                logo: "https://upload.wikimedia.org/wikipedia/en/thumb/c/cd/IIM%2C_Ahmedabad_Logo.svg/1200px-IIM%2C_Ahmedabad_Logo.svg.png"
            },
            {
                name: "Banaras Hindu University",
                shortName: "BHU",
                logo: "https://upload.wikimedia.org/wikipedia/en/c/ca/Banaras_Hindu_University_Emblem_Seal_Transparent.png"
            }
        ];

        // Danh sách tên Ấn Độ
        const indianNames = [
            "Aarav Sharma", "Vivaan Patel", "Aditya Gupta", "Vihaan Singh", "Arjun Kumar",
            "Sai Reddy", "Reyansh Agarwal", "Ayaan Khan", "Krishna Joshi", "Ishaan Verma",
            "Ananya Sharma", "Diya Patel", "Aadhya Gupta", "Kavya Singh", "Anvi Kumar",
            "Saanvi Reddy", "Larisa Agarwal", "Myra Khan", "Aanya Joshi", "Pihu Verma",
            "Aryan Mehta", "Kabir Nair", "Shivansh Roy", "Atharv Das", "Rudra Bose",
            "Priya Iyer", "Riya Ghosh", "Sara Banerjee", "Tara Kulkarni", "Nisha Desai"
        ];

        // Danh sách chuyên ngành
        const departments = [
            "Computer Science", "Information Technology", "Electronics Engineering",
            "Mechanical Engineering", "Civil Engineering", "Chemical Engineering",
            "Biotechnology", "Physics", "Mathematics", "Chemistry", "Business Administration",
            "Economics", "Psychology", "English Literature", "History", "Political Science"
        ];
        // Hàm lấy ảnh từ thispersonnotexist.org qua proxy server
        async function getRandomStudentPhoto() {
            try {
                // Sử dụng proxy server local để bypass CORS
                const response = await fetch('/api/load-faces', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        "type": "R",
                        "age": "21-35",
                        "race": "asian", 
                        "emotion": "none"
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.fc && data.fc.length > 0) {
                        // Chọn ngẫu nhiên một ảnh từ danh sách
                        const randomIndex = Math.floor(Math.random() * data.fc.length);
                        const base64Image = data.fc[randomIndex];
                        
                        // Tạo URL qua proxy server để tránh CORS khi download
                        const imageUrl = `/api/image/${base64Image}`;
                        
                        return imageUrl;
                        
                    } else {
                        throw new Error('Không có ảnh trong response');
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(`HTTP ${response.status}: ${errorData.error || response.statusText}`);
                }
                
            } catch (error) {
                throw error; // Re-throw để báo lỗi cho user
            }
        }

        function getRandomElement(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function generateRandomDate() {
            const today = new Date();
            const minAge = 20;
            const maxAge = 25;
            
            const randomAge = minAge + Math.floor(Math.random() * (maxAge - minAge + 1));
            const birthYear = today.getFullYear() - randomAge;
            const birthMonth = Math.floor(Math.random() * 12) + 1;
            const birthDay = Math.floor(Math.random() * 28) + 1;
            
            return `${birthYear}-${birthMonth.toString().padStart(2, '0')}-${birthDay.toString().padStart(2, '0')}`;
        }

        function generateStudentID(universityShort) {
            const year = new Date().getFullYear();
            const randomNumber = Math.floor(Math.random() * 9999999999).toString().padStart(10, '0');
            return `${universityShort}${year}.${randomNumber}`;
        }

        function generateCourse() {
            const currentYear = new Date().getFullYear();
            const startYear = currentYear;
            const endYear = startYear + 4;
            return `${startYear} - ${endYear}`;
        }

        function generateClass() {
            const departments = ["CS", "IT", "EE", "ME", "CE", "CHE", "BT"];
            const degrees = ["BTech", "MTech", "PhD", "BSc", "MSc"];
            const year = new Date().getFullYear();
            
            return `${getRandomElement(departments)}-${getRandomElement(degrees)}-${year}`;
        }

        function generateValidUntil() {
            const today = new Date();
            const validDate = new Date(today.getFullYear() + 3, today.getMonth(), today.getDate());
            return validDate.toLocaleDateString('en-GB');
        }

        async function generateStudentCard() {
            // Enhanced loading state with better UX
            const generateBtn = document.querySelector('.btn-generate');
            const btnText = generateBtn.querySelector('.btn-text') || generateBtn;
            const originalText = btnText.textContent;
            const card = document.querySelector('.card');
            
            // Add loading spinner and disable button
            btnText.innerHTML = '<span class="loading-spinner"></span>Generating...';
            generateBtn.disabled = true;
            generateBtn.style.pointerEvents = 'none';
            card.classList.add('generating');

            try {
                // Add a small delay for better UX perception
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const university = getRandomElement(universities);
                const studentName = getRandomElement(indianNames);
                const department = getRandomElement(departments);
                const dob = generateRandomDate();
                const course = generateCourse();
                const studentClass = generateClass();
                const studentID = generateStudentID(university.shortName);
                const validUntil = generateValidUntil();

                // Show progress update
                btnText.innerHTML = '<span class="loading-spinner"></span>Loading Photos...';
                
                // Get student photo with error handling
                const studentPhoto = await getRandomStudentPhoto();

                // Update card information with smooth transition
                card.style.opacity = '0.7';
                
                await new Promise(resolve => setTimeout(resolve, 300)); // Brief pause for transition
                
                document.getElementById('university-name').textContent = university.name;
                document.getElementById('student-name').textContent = studentName;
                document.getElementById('student-dob').textContent = dob;
                document.getElementById('student-course').textContent = course;
                document.getElementById('student-class').textContent = studentClass;
                document.getElementById('student-department').textContent = department;
                document.getElementById('student-id').innerHTML = `Student ID: ${studentID}`;
                document.getElementById('valid-until').textContent = validUntil;
                
                // Load images with progress feedback
                btnText.innerHTML = '<span class="loading-spinner"></span>Loading Images...';
                
                document.getElementById('university-logo').src = university.logo;
                document.getElementById('student-photo').src = studentPhoto;
                
                // Update barcode
                const barcodeUrl = `/api/barcode?data=${encodeURIComponent(university.name)}&code=Code128`;
                document.getElementById('barcode').src = barcodeUrl;
                
                // Restore card opacity with animation
                card.style.opacity = '1';
                card.style.transform = 'scale(0.95)';
                await new Promise(resolve => setTimeout(resolve, 100));
                card.style.transform = 'scale(1)';
                
                // Final delay to ensure images are loaded
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Success feedback with notification
                btnText.innerHTML = '✅ Generated Successfully!';
                showNotification('🎉 Student card generated successfully!', 'success', 2000);
                await new Promise(resolve => setTimeout(resolve, 1000));

            } catch (error) {
                console.error('Generation error:', error);
                // Enhanced error feedback with notification
                btnText.innerHTML = '❌ Generation Failed';
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Show user-friendly error message via notification
                const errorMessage = error.message.includes('fetch') 
                    ? 'Network error: Please check your internet connection and try again.' 
                    : `Error: ${error.message}`;
                
                showNotification(`❌ Unable to generate student card.<br><small>${errorMessage}</small>`, 'error', 5000);
            } finally {
                // Restore button state with smooth transition
                setTimeout(() => {
                    btnText.textContent = originalText;
                    generateBtn.disabled = false;
                    generateBtn.style.pointerEvents = 'auto';
                    card.classList.remove('generating');
                    
                    // Enable download button with animation
                    const downloadBtn = document.querySelector('.btn-download');
                    downloadBtn.disabled = false;
                    downloadBtn.style.opacity = '1';
                    downloadBtn.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        downloadBtn.style.transform = 'scale(1)';
                    }, 200);
                }, 500);
            }
        }

        async function downloadCard() {
            const downloadBtn = document.querySelector('.btn-download');
            const originalText = downloadBtn.textContent;
            
            try {
                // Enhanced loading state for download
                downloadBtn.innerHTML = '<span class="loading-spinner"></span>Creating Image...';
                downloadBtn.disabled = true;
                downloadBtn.style.pointerEvents = 'none';
                
                // Add a small delay for UX
                await new Promise(resolve => setTimeout(resolve, 300));
                
                downloadBtn.innerHTML = '<span class="loading-spinner"></span>Processing...';
                
                // Create the image
                await drawCardManually();
                
                // Success feedback with notification
                downloadBtn.innerHTML = '✅ Download Complete!';
                showNotification('💾 Card downloaded successfully!', 'success', 2000);
                await new Promise(resolve => setTimeout(resolve, 1500));
                
            } catch (error) {
                console.error('Download error:', error);
                downloadBtn.innerHTML = '❌ Download Failed';
                await new Promise(resolve => setTimeout(resolve, 1500));
                showNotification(`❌ Unable to download card.<br><small>Error: ${error.message}</small>`, 'error', 4000);
            } finally {
                // Restore button state
                setTimeout(() => {
                    downloadBtn.textContent = originalText;
                    downloadBtn.disabled = false;
                    downloadBtn.style.pointerEvents = 'auto';
                }, 500);
            }
        }
        
        async function drawCardManually() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Kích thước canvas - match chính xác với web design
            canvas.width = 1200; // 600px * 2
            canvas.height = 800;  // ~400px * 2
            
            // Background
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Card setup - centered
            const cardX = 100, cardY = 100;
            const cardWidth = 1000, cardHeight = 600;
            
            // Card shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
            ctx.fillRect(cardX + 8, cardY + 8, cardWidth, cardHeight);
            
            // Card background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(cardX, cardY, cardWidth, cardHeight);
            
            // Card border với rounded corners
            ctx.strokeStyle = '#222222';
            ctx.lineWidth = 4;
            ctx.strokeRect(cardX, cardY, cardWidth, cardHeight);
            
            // Header background
            const headerHeight = 160;
            ctx.fillStyle = '#6a9ed8';
            ctx.fillRect(cardX, cardY, cardWidth, headerHeight);
            
            // Load và vẽ logo university
            try {
                const logoImg = new Image();
                logoImg.crossOrigin = 'anonymous';
                await new Promise((resolve) => {
                    logoImg.onload = resolve;
                    logoImg.onerror = resolve;
                    logoImg.src = document.getElementById('university-logo').src;
                    setTimeout(resolve, 3000);
                });
                
                if (logoImg.complete && logoImg.naturalWidth > 0) {
                    // Logo background trắng - match với CSS (.logo)
                    ctx.fillStyle = '#ffffff';
                    const logoSize = 128; // 80px * 1.6 scale
                    const logoX = cardX + 32;
                    const logoY = cardY + 16; 
                    
                    ctx.fillRect(logoX, logoY, logoSize, logoSize);
                    
                    // Draw logo với padding 8px
                    ctx.drawImage(logoImg, logoX + 8, logoY + 8, logoSize - 16, logoSize - 16);
                } else {
                    // Logo placeholder
                    const logoSize = 128;
                    const logoX = cardX + 32;
                    const logoY = cardY + 16;
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(logoX, logoY, logoSize, logoSize);
                    ctx.strokeStyle = '#cccccc';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(logoX, logoY, logoSize, logoSize);
                    ctx.fillStyle = '#666666';
                    ctx.font = 'bold 18px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('LOGO', logoX + logoSize/2, logoY + logoSize/2);
                }
            } catch (e) {
                console.warn('Logo loading failed:', e);
            }
            
            // University name - bắt đầu từ bên phải logo
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 42px Arial'; // Match với CSS .title
            ctx.textAlign = 'left';
            const universityName = document.getElementById('university-name').textContent;
            
            const textStartX = cardX + 192; // 32 + 128 + 32 margin
            const maxTextWidth = 740; // Remaining width
            const lines = wrapText(ctx, universityName, maxTextWidth);
            
            lines.forEach((line, index) => {
                ctx.fillText(line, textStartX, cardY + 50 + (index * 45));
            });
            
            // "STUDENT CARD" text - positioned below university name
            ctx.fillStyle = '#cc0000';
            ctx.font = 'bold 36px Arial'; // Match với CSS .subtitle
            const studentCardY = cardY + 50 + (lines.length * 45) + 15;
            ctx.fillText('STUDENT CARD', textStartX, studentCardY);
            
            // Info section - bắt đầu dưới header
            const infoY = cardY + headerHeight + 32;
            
            // Load và vẽ student photo
            try {
                const photoImg = new Image();
                photoImg.crossOrigin = 'anonymous';
                await new Promise((resolve) => {
                    photoImg.onload = resolve;
                    photoImg.onerror = resolve;
                    photoImg.src = document.getElementById('student-photo').src;
                    setTimeout(resolve, 3000);
                });
                
                // Photo dimensions match CSS .avatar
                const photoWidth = 176; // 110px * 1.6
                const photoHeight = 216; // 135px * 1.6
                const photoX = cardX + 48;
                const photoY = infoY;
                
                if (photoImg.complete && photoImg.naturalWidth > 0) {
                    // Photo border
                    ctx.strokeStyle = '#888888';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(photoX, photoY, photoWidth, photoHeight);
                    
                    // Clip và draw photo
                    ctx.save();
                    ctx.beginPath();
                    ctx.rect(photoX, photoY, photoWidth, photoHeight);
                    ctx.clip();
                    ctx.drawImage(photoImg, photoX, photoY, photoWidth, photoHeight);
                    ctx.restore();
                } else {
                    // Photo placeholder
                    ctx.fillStyle = '#eeeeee';
                    ctx.fillRect(photoX, photoY, photoWidth, photoHeight);
                    ctx.strokeStyle = '#888888';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(photoX, photoY, photoWidth, photoHeight);
                    ctx.fillStyle = '#666666';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('PHOTO', photoX + photoWidth/2, photoY + photoHeight/2);
                }
            } catch (e) {
                console.warn('Photo loading failed:', e);
            }
            
            // Student details - positioning bên phải photo
            ctx.textAlign = 'left';
            const detailsX = cardX + 48 + 176 + 44; // photoX + photoWidth + margin (match CSS)
            
            const details = [
                { label: 'Name:', value: document.getElementById('student-name').textContent, bold: true },
                { label: 'Date of Birth:', value: document.getElementById('student-dob').textContent },
                { label: 'Course:', value: document.getElementById('student-course').textContent },
                { label: 'Class:', value: document.getElementById('student-class').textContent },
                { label: 'Department:', value: document.getElementById('student-department').textContent }
            ];
            
            details.forEach((detail, index) => {
                const y = infoY + 20 + (index * 36); // Match CSS line spacing
                
                // Label (blue, bold) - match CSS .label
                ctx.fillStyle = '#1a7ec7';
                ctx.font = 'bold 27px Arial'; // Match CSS font-size
                
                // Fixed width cho label như CSS (.row .label width: 110px)
                const labelWidth = 176; // 110px * 1.6 scale
                ctx.fillText(detail.label, detailsX, y);
                
                // Value - positioned after fixed label width
                ctx.fillStyle = '#000000';
                ctx.font = detail.bold ? 'bold 29px Arial' : '27px Arial'; // Match CSS
                ctx.fillText(detail.value, detailsX + labelWidth + 16, y);
            });
            
            // Valid until - match CSS .footer positioning
            ctx.fillStyle = '#444444';
            ctx.font = '22px Arial'; // Match CSS .footer font-size
            const validText = `Valid until: ${document.getElementById('valid-until').textContent}`;
            const validY = infoY + 240; // Tăng khoảng cách để không đè lên photo
            ctx.fillText(validText, cardX + 48, validY);
            
            // Load và vẽ barcode thật từ API
            try {
                const barcodeImg = new Image();
                barcodeImg.crossOrigin = 'anonymous';
                await new Promise((resolve) => {
                    barcodeImg.onload = resolve;
                    barcodeImg.onerror = resolve;
                    barcodeImg.src = document.getElementById('barcode').src;
                    setTimeout(resolve, 3000); // Timeout after 3 seconds
                });
                
                const barcodeY = validY + 24;
                const barcodeStartX = cardX + 80; // Centered like CSS
                const barcodeWidth = 840; // 90% of card width
                const barcodeHeight = 60; // Match CSS height scaled
                
                if (barcodeImg.complete && barcodeImg.naturalWidth > 0) {
                    // Draw real barcode image
                    ctx.drawImage(barcodeImg, barcodeStartX, barcodeY, barcodeWidth, barcodeHeight);
                } else {
                    // Fallback: draw simple barcode pattern if image fails
                    ctx.fillStyle = '#000000';
                    const universityNameForBarcode = document.getElementById('university-name').textContent;
                    for (let i = 0; i < barcodeWidth; i += 3) {
                        const charIndex = Math.floor(i / 20) % universityNameForBarcode.length;
                        const charCode = universityNameForBarcode.charCodeAt(charIndex);
                        const shouldDraw = (charCode + i) % 7 !== 0;
                        if (shouldDraw) {
                            const lineWidth = ((charCode + i) % 3) + 1;
                            const lineHeight = barcodeHeight * (0.8 + ((charCode + i) % 3) * 0.1);
                            ctx.fillRect(barcodeStartX + i, barcodeY, lineWidth, lineHeight);
                        }
                    }
                }
            } catch (e) {
                console.warn('Barcode loading failed:', e);
                // Fallback barcode drawing code ở đây
                ctx.fillStyle = '#000000';
                const barcodeY = validY + 24;
                const barcodeStartX = cardX + 80;
                const barcodeWidth = 840;
                const barcodeHeight = 60;
                const universityNameForBarcode = document.getElementById('university-name').textContent;
                for (let i = 0; i < barcodeWidth; i += 3) {
                    const charIndex = Math.floor(i / 20) % universityNameForBarcode.length;
                    const charCode = universityNameForBarcode.charCodeAt(charIndex);
                    const shouldDraw = (charCode + i) % 7 !== 0;
                    if (shouldDraw) {
                        const lineWidth = ((charCode + i) % 3) + 1;
                        const lineHeight = barcodeHeight * (0.8 + ((charCode + i) % 3) * 0.1);
                        ctx.fillRect(barcodeStartX + i, barcodeY, lineWidth, lineHeight);
                    }
                }
            }
            
            // Footer elements - match CSS .id-number và .region positioning
            const footerY = cardY + cardHeight - 36; // Match CSS bottom positioning
            
            // Student ID (bottom left)
            ctx.fillStyle = '#222222';
            ctx.font = '24px Arial'; // Match CSS .id-number font-size
            ctx.textAlign = 'left';
            const studentId = document.getElementById('student-id').textContent;
            ctx.fillText(studentId, cardX + 48, footerY);
            
            // India (bottom right)
            ctx.textAlign = 'right';
            ctx.fillText('India', cardX + cardWidth - 48, footerY);
            
            // Download the canvas
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                link.download = `student-card-${timestamp}.png`;
                link.href = url;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                console.log('Download completed successfully!');
            }, 'image/png', 1.0);
        }
        
        function wrapText(ctx, text, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = words[0];
            
            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = ctx.measureText(currentLine + ' ' + word).width;
                if (width < maxWidth) {
                    currentLine += ' ' + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }
        
        // Notification System
        function showNotification(message, type = 'info', duration = 3000) {
            // Remove existing notification if any
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = message;
            
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Hide notification
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }

        // Generate initial card khi trang được load
        window.onload = async function() {
            showNotification('🚀 Welcome to Student Card Generator!<br><small>Generating your first card...</small>', 'info', 3000);
            await generateStudentCard();
        };
    </script>
</body>
</html>